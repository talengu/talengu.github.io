<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Netfilter框架 on 一塘</title><link>https://example.com/tags/netfilter%E6%A1%86%E6%9E%B6/</link><description>Recent content in Netfilter框架 on 一塘</description><generator>Hugo</generator><language>zh-cn</language><lastBuildDate>Wed, 06 Jul 2022 16:00:04 +0000</lastBuildDate><atom:link href="https://example.com/tags/netfilter%E6%A1%86%E6%9E%B6/index.xml" rel="self" type="application/rss+xml"/><item><title>「转」Linux内核数据包bridge上转发流程</title><link>https://example.com/post/c5-linux/linux/linux-bridge-forward/</link><pubDate>Wed, 06 Jul 2022 16:00:04 +0000</pubDate><guid>https://example.com/post/c5-linux/linux/linux-bridge-forward/</guid><description>&lt;blockquote>
&lt;p>原文地址 &lt;a href="https://blog.csdn.net/hhhhhyyyyy8/article/details/102133863">blog.csdn.net&lt;/a>
@hhhhhyyyyy8 @4.15.1&lt;/p>&lt;/blockquote>
&lt;h2 id="前言">前言&lt;/h2>
&lt;p>linux 内核源代码变动怎么这么大，handle_bridge 函数居然没有了，本来接着准备以 3.9.1 分析的，但发现和后面的又变了，还是以 4.15.1 现在电脑上用的版本分析吧。&lt;/p>
&lt;p>&lt;strong>linux kernel：4.15.1&lt;/strong>&lt;/p>
&lt;p>best of best [&lt;a href="url">link&lt;/a>](&lt;a href="https://upload.wikimedia.org/wikipedia/commons/3/37/Netfilter-packet-flow.svg">https://upload.wikimedia.org/wikipedia/commons/3/37/Netfilter-packet-flow.svg&lt;/a>)&lt;/p>
&lt;p>




 


&lt;div style="text-align: center;">
&lt;img src="Netfilter-packet-flow5.svg" 
 alt="" 
 
 style="width:80%;" 
/>
&lt;/div>&lt;/p>
&lt;p>先看三张图片&lt;/p>
&lt;p>&lt;a href="https://blog.csdn.net/NW_NW_NW/article/details/76153027">IMG skb桥转发蓝图&lt;/a>





 


&lt;div style="text-align: center;">
&lt;img src="20191005153149853.jpg" 
 alt="" 
 
 style="width:80%;" 
/>
&lt;/div>&lt;/p>
&lt;p>&lt;a href="https://blog.csdn.net/u012247418/article/details/90137663">IMG linux TCP/IP L2层数据包接收流程&lt;/a>





 


&lt;div style="text-align: center;">
&lt;img src="t_70.png" 
 alt="" 
 
 style="width:80%;" 
/>
&lt;/div>&lt;/p>
&lt;p>&lt;a href="https://www.cnblogs.com/xuanxuanBOSS/p/11424290.html">IMG 浅析ebtables的概念和一些基本应用&lt;/a>





 


&lt;div style="text-align: center;">
&lt;img src="netfilter.png" 
 alt="" 
 
 style="width:80%;" 
/>
&lt;/div>&lt;/p>
&lt;blockquote>
&lt;p>tips: linux 内核版本不一样，流程函数会发生细微改变。&lt;/p>&lt;/blockquote>
&lt;!-- more -->
&lt;h2 id="1-br_handle_frame">1. br_handle_frame()&lt;/h2>
&lt;p>作用：&lt;/p>
&lt;ol>
&lt;li>
&lt;p>对于需要转发的报文，调用 &lt;code>NF_BR_PRE_ROUTING&lt;/code> 处钩子函数，结束后，进入 &lt;code>br_handle_frame_finish()&lt;/code> 函数；&lt;/p>
&lt;/li>
&lt;li>
&lt;p>对于 STP 报文，调用 &lt;code>NF_BR_LOCAL_IN&lt;/code> 处钩子函数，结束后，进入 &lt;code>br_handle_local_finish()&lt;/code> 函数，在 &lt;code>br_handle_local_finish()&lt;/code> 函数中会调用 &lt;code>br_pass_frame_up()&lt;/code> 函数。&lt;/p>
&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">//linux/net/bridge/br_input.c
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#75715e">/*
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * Return NULL if skb is handled
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * note: already called with rcu_read_lock
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">rx_handler_result_t&lt;/span> &lt;span style="color:#a6e22e">br_handle_frame&lt;/span>(&lt;span style="color:#66d9ef">struct&lt;/span> sk_buff &lt;span style="color:#f92672">**&lt;/span>pskb)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>	&lt;span style="color:#66d9ef">struct&lt;/span> net_bridge_port &lt;span style="color:#f92672">*&lt;/span>p;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>	&lt;span style="color:#66d9ef">struct&lt;/span> sk_buff &lt;span style="color:#f92672">*&lt;/span>skb &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#f92672">*&lt;/span>pskb;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>	&lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">unsigned&lt;/span> &lt;span style="color:#66d9ef">char&lt;/span> &lt;span style="color:#f92672">*&lt;/span>dest &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">eth_hdr&lt;/span>(skb)&lt;span style="color:#f92672">-&amp;gt;&lt;/span>h_dest;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>	&lt;span style="color:#66d9ef">br_should_route_hook_t&lt;/span> &lt;span style="color:#f92672">*&lt;/span>rhook;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> 
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>	&lt;span style="color:#75715e">/*如果是环回地址，直接返回RX_HANDLER_PASS*/&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>	&lt;span style="color:#66d9ef">if&lt;/span> (&lt;span style="color:#a6e22e">unlikely&lt;/span>(skb&lt;span style="color:#f92672">-&amp;gt;&lt;/span>pkt_type &lt;span style="color:#f92672">==&lt;/span> PACKET_LOOPBACK))
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>		&lt;span style="color:#66d9ef">return&lt;/span> RX_HANDLER_PASS;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>	
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>	&lt;span style="color:#75715e">/*判断源MAC地址是否是有效的地址，不是直接丢弃，源MAC地址不能是多播地址和全0地址*/&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>	&lt;span style="color:#66d9ef">if&lt;/span> (&lt;span style="color:#f92672">!&lt;/span>&lt;span style="color:#a6e22e">is_valid_ether_addr&lt;/span>(&lt;span style="color:#a6e22e">eth_hdr&lt;/span>(skb)&lt;span style="color:#f92672">-&amp;gt;&lt;/span>h_source))
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>		&lt;span style="color:#66d9ef">goto&lt;/span> drop;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>	&lt;span style="color:#75715e">/*判断是否是共享数据包，若是则clone该数据包；若clone时分配内存出错，返回NULL*/&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>	skb &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">skb_share_check&lt;/span>(skb, GFP_ATOMIC);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>	&lt;span style="color:#66d9ef">if&lt;/span> (&lt;span style="color:#f92672">!&lt;/span>skb)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>		&lt;span style="color:#66d9ef">return&lt;/span> RX_HANDLER_CONSUMED;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> 
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>	&lt;span style="color:#75715e">/*获取dev对应的网桥端口*/&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>	p &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">br_port_get_rcu&lt;/span>(skb&lt;span style="color:#f92672">-&amp;gt;&lt;/span>dev);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>	&lt;span style="color:#66d9ef">if&lt;/span> (p&lt;span style="color:#f92672">-&amp;gt;&lt;/span>flags &lt;span style="color:#f92672">&amp;amp;&lt;/span> BR_VLAN_TUNNEL) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>		&lt;span style="color:#66d9ef">if&lt;/span> (&lt;span style="color:#a6e22e">br_handle_ingress_vlan_tunnel&lt;/span>(skb, p,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>						 &lt;span style="color:#a6e22e">nbp_vlan_group_rcu&lt;/span>(p)))
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>			&lt;span style="color:#66d9ef">goto&lt;/span> drop;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>	}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>	
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>	&lt;span style="color:#75715e">/*特殊MAC地址处理*/&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>	&lt;span style="color:#75715e">//如果目的mac地址是本地链路地址link local reserved addr (01:80:c2:00:00:0X) STP报文
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>	&lt;span style="color:#66d9ef">if&lt;/span> (&lt;span style="color:#a6e22e">unlikely&lt;/span>(&lt;span style="color:#a6e22e">is_link_local_ether_addr&lt;/span>(dest))) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>		u16 fwd_mask &lt;span style="color:#f92672">=&lt;/span> p&lt;span style="color:#f92672">-&amp;gt;&lt;/span>br&lt;span style="color:#f92672">-&amp;gt;&lt;/span>group_fwd_mask_required;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> 
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>		&lt;span style="color:#75715e">/*
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">		 * See IEEE 802.1D Table 7-10 Reserved addresses
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">		 *
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">		 * Assignment		 		Value
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">		 * Bridge Group Address		01-80-C2-00-00-00
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">		 * (MAC Control) 802.3		01-80-C2-00-00-01
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">		 * (Link Aggregation) 802.3	01-80-C2-00-00-02
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">		 * 802.1X PAE address		01-80-C2-00-00-03
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">		 *
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">		 * 802.1AB LLDP 		01-80-C2-00-00-0E
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">		 *
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">		 * Others reserved for future standardization
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">		 */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>		fwd_mask &lt;span style="color:#f92672">|=&lt;/span> p&lt;span style="color:#f92672">-&amp;gt;&lt;/span>group_fwd_mask;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>		&lt;span style="color:#66d9ef">switch&lt;/span> (dest[&lt;span style="color:#ae81ff">5&lt;/span>]) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>		&lt;span style="color:#66d9ef">case&lt;/span> &lt;span style="color:#ae81ff">0x00&lt;/span>&lt;span style="color:#f92672">:&lt;/span>	&lt;span style="color:#75715e">/* Bridge Group Address */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>			&lt;span style="color:#75715e">/* If STP is turned off,
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">			 then must forward to keep loop detection */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>			&lt;span style="color:#66d9ef">if&lt;/span> (p&lt;span style="color:#f92672">-&amp;gt;&lt;/span>br&lt;span style="color:#f92672">-&amp;gt;&lt;/span>stp_enabled &lt;span style="color:#f92672">==&lt;/span> BR_NO_STP &lt;span style="color:#f92672">||&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>			 fwd_mask &lt;span style="color:#f92672">&amp;amp;&lt;/span> (&lt;span style="color:#ae81ff">1u&lt;/span> &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> dest[&lt;span style="color:#ae81ff">5&lt;/span>]))
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>				&lt;span style="color:#66d9ef">goto&lt;/span> forward;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>			&lt;span style="color:#f92672">*&lt;/span>pskb &lt;span style="color:#f92672">=&lt;/span> skb;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>			&lt;span style="color:#a6e22e">__br_handle_local_finish&lt;/span>(skb);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>			&lt;span style="color:#66d9ef">return&lt;/span> RX_HANDLER_PASS;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> 
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>		&lt;span style="color:#66d9ef">case&lt;/span> &lt;span style="color:#ae81ff">0x01&lt;/span>&lt;span style="color:#f92672">:&lt;/span>	&lt;span style="color:#75715e">/* IEEE MAC (Pause) */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>			&lt;span style="color:#66d9ef">goto&lt;/span> drop;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> 
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>		&lt;span style="color:#66d9ef">case&lt;/span> &lt;span style="color:#ae81ff">0x0E&lt;/span>&lt;span style="color:#f92672">:&lt;/span>	&lt;span style="color:#75715e">/* 802.1AB LLDP */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>			fwd_mask &lt;span style="color:#f92672">|=&lt;/span> p&lt;span style="color:#f92672">-&amp;gt;&lt;/span>br&lt;span style="color:#f92672">-&amp;gt;&lt;/span>group_fwd_mask;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>			&lt;span style="color:#66d9ef">if&lt;/span> (fwd_mask &lt;span style="color:#f92672">&amp;amp;&lt;/span> (&lt;span style="color:#ae81ff">1u&lt;/span> &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> dest[&lt;span style="color:#ae81ff">5&lt;/span>]))
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>				&lt;span style="color:#66d9ef">goto&lt;/span> forward;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>			&lt;span style="color:#f92672">*&lt;/span>pskb &lt;span style="color:#f92672">=&lt;/span> skb;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>			&lt;span style="color:#a6e22e">__br_handle_local_finish&lt;/span>(skb);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>			&lt;span style="color:#66d9ef">return&lt;/span> RX_HANDLER_PASS;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> 
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>		&lt;span style="color:#66d9ef">default&lt;/span>&lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>			&lt;span style="color:#75715e">/* Allow selective forwarding for most other protocols */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>			fwd_mask &lt;span style="color:#f92672">|=&lt;/span> p&lt;span style="color:#f92672">-&amp;gt;&lt;/span>br&lt;span style="color:#f92672">-&amp;gt;&lt;/span>group_fwd_mask;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>			&lt;span style="color:#66d9ef">if&lt;/span> (fwd_mask &lt;span style="color:#f92672">&amp;amp;&lt;/span> (&lt;span style="color:#ae81ff">1u&lt;/span> &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> dest[&lt;span style="color:#ae81ff">5&lt;/span>]))
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>				&lt;span style="color:#66d9ef">goto&lt;/span> forward;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>		}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> 
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>		&lt;span style="color:#75715e">/* Deliver packet to local host only */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>		&lt;span style="color:#75715e">/*调用NF_BR_LOCAL_IN处钩子函数，结束后，进入br_handle_local_finish函数*/&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>		&lt;span style="color:#a6e22e">NF_HOOK&lt;/span>(NFPROTO_BRIDGE, NF_BR_LOCAL_IN, &lt;span style="color:#a6e22e">dev_net&lt;/span>(skb&lt;span style="color:#f92672">-&amp;gt;&lt;/span>dev),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>			NULL, skb, skb&lt;span style="color:#f92672">-&amp;gt;&lt;/span>dev, NULL, br_handle_local_finish);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>		&lt;span style="color:#66d9ef">return&lt;/span> RX_HANDLER_CONSUMED;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>	}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> 
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>forward:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>	&lt;span style="color:#66d9ef">switch&lt;/span> (p&lt;span style="color:#f92672">-&amp;gt;&lt;/span>state) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>	&lt;span style="color:#75715e">//网桥端口处于转发状态
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>	&lt;span style="color:#66d9ef">case&lt;/span> BR_STATE_FORWARDING:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>		rhook &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">rcu_dereference&lt;/span>(br_should_route_hook);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>		&lt;span style="color:#66d9ef">if&lt;/span> (rhook) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>			&lt;span style="color:#66d9ef">if&lt;/span> ((&lt;span style="color:#f92672">*&lt;/span>rhook)(skb)) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>				&lt;span style="color:#f92672">*&lt;/span>pskb &lt;span style="color:#f92672">=&lt;/span> skb;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>				&lt;span style="color:#66d9ef">return&lt;/span> RX_HANDLER_PASS;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>			}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>			dest &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">eth_hdr&lt;/span>(skb)&lt;span style="color:#f92672">-&amp;gt;&lt;/span>h_dest;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>		}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>		&lt;span style="color:#75715e">/* fall through */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>	&lt;span style="color:#75715e">/*网桥端口处于学习状态，处于转发状态也会执行下面的代码，因为上面的case没有break。*/&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>	&lt;span style="color:#66d9ef">case&lt;/span> BR_STATE_LEARNING:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>	&lt;span style="color:#75715e">/*数据包目的MAC为网桥的Mac，发往本地的数据包*/&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>		&lt;span style="color:#66d9ef">if&lt;/span> (&lt;span style="color:#a6e22e">ether_addr_equal&lt;/span>(p&lt;span style="color:#f92672">-&amp;gt;&lt;/span>br&lt;span style="color:#f92672">-&amp;gt;&lt;/span>dev&lt;span style="color:#f92672">-&amp;gt;&lt;/span>dev_addr, dest))
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>			skb&lt;span style="color:#f92672">-&amp;gt;&lt;/span>pkt_type &lt;span style="color:#f92672">=&lt;/span> PACKET_HOST;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>		&lt;span style="color:#75715e">/*调用NF_BR_PRE_ROUTING处钩子函数，结束后进入br_handle_frame_finish函数*/&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>		&lt;span style="color:#a6e22e">NF_HOOK&lt;/span>(NFPROTO_BRIDGE, NF_BR_PRE_ROUTING,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>			&lt;span style="color:#a6e22e">dev_net&lt;/span>(skb&lt;span style="color:#f92672">-&amp;gt;&lt;/span>dev), NULL, skb, skb&lt;span style="color:#f92672">-&amp;gt;&lt;/span>dev, NULL,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>			br_handle_frame_finish);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>		&lt;span style="color:#66d9ef">break&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>	&lt;span style="color:#66d9ef">default&lt;/span>&lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>drop:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>		&lt;span style="color:#a6e22e">kfree_skb&lt;/span>(skb);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>	}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>	&lt;span style="color:#66d9ef">return&lt;/span> RX_HANDLER_CONSUMED;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>相关函数&lt;/p></description></item></channel></rss>